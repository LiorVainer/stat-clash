name: ✅ Next.js CI with pnpm

on:
    pull_request:
        branches: [master, dev]

jobs:
    setup:
        name: 🧰 Install & Cache
        runs-on: ubuntu-latest
        outputs:
            cache-hit: ${{ steps.cache.outputs.cache-hit }}

        steps:
            - name: ⬇️ Checkout repo
              uses: actions/checkout@v4

            - name: 📦 Setup pnpm 10.5
              uses: pnpm/action-setup@v2
              with:
                  version: 10.5
                  standalone: true

            - name: 🧰 Setup Node.js (with pnpm caching)
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: 'pnpm'

            - name: 📥 Install dependencies
              run: pnpm install --frozen-lockfile

            - name: 📤 Upload node_modules
              uses: actions/upload-artifact@v4
              with:
                  name: node_modules
                  path: node_modules/

    lint:
        name: 🔍 Lint
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v2
              with:
                  version: 10.5
                  standalone: true
            - name: 📥 Restore node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node_modules
                  path: node_modules
            - run: pnpm lint

    prettier:
        name: 🧹 Prettier
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v2
              with:
                  version: 10.5
                  standalone: true
            - name: 📥 Restore node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node_modules
                  path: node_modules
            - run: pnpm prettier . --check

    build:
        name: 🛠 Build
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v2
              with:
                  version: 10.5
                  standalone: true
            - name: 📥 Restore node_modules
              uses: actions/download-artifact@v4
              with:
                  name: node_modules
                  path: node_modules
            - run: pnpm build
